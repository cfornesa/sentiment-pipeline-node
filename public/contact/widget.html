<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sovereign Contact Agent</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #fff; color: #334155; }
        .widget-form { padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; }
        .label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .input { width: 100%; padding: 12px; margin: 6px 0 16px 0; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .btn { background: #05386B; color: #fff; border: none; padding: 14px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600; }
        #successMsg { display: none; color: #166534; background: #dcfce7; padding: 20px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="widget-form" id="formWrapper">
    <div id="successMsg">âœ” Inquiry dispatched to the researcher.</div>
    <form id="msgForm">
        <label class="label">Return Address</label>
        <input type="email" id="senderEmail" class="input" required>
        <label class="label">Subject</label>
        <input type="text" id="subject" class="input" required>
        <label class="label">Message</label>
        <textarea id="message" class="input" style="height: 120px; resize: none;" required></textarea>
        <button type="submit" class="btn">Send Secure Message</button>
    </form>
</div>

<script src="https://www.google.com/recaptcha/api.js?render=LOAD_DYNAMICALLY"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    async function initWidget() {
        const res = await fetch(`/api/contact/config/${id}`);
        const { siteKey } = await res.json();

        // Dynamically load reCAPTCHA
        const script = document.createElement('script');
        script.src = `https://www.google.com/recaptcha/api.js?render=${siteKey}`;
        document.head.appendChild(script);

        document.getElementById('msgForm').onsubmit = async (e) => {
            e.preventDefault();
            grecaptcha.ready(() => {
                grecaptcha.execute(siteKey, {action: 'contact'}).then(async (token) => {
                    const postRes = await fetch('/api/contact/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id,
                            senderEmail: document.getElementById('senderEmail').value,
                            subject: document.getElementById('subject').value,
                            message: document.getElementById('message').value,
                            captchaToken: token
                        })
                    });
                    if (postRes.ok) {
                        document.getElementById('msgForm').style.display = 'none';
                        document.getElementById('successMsg').style.display = 'block';
                    }
                });
            });
        };
    }
    if (id) initWidget();
</script>
</body>
</html>