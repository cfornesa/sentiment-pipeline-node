<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Visualization Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* DESIGN PHILOSOPHY: Headless Minimalism
           Optimized for Iframe injection. The background is transparent to 
           allow seamless blending with the host portfolio/case study.
        */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100%; 
            overflow: hidden; 
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: transparent; 
        }
        .viz-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            padding: 10px; 
            box-sizing: border-box; 
        }
        #viz-header { 
            text-align: center; 
            font-size: 13px; 
            font-weight: 700; 
            color: #05386B; 
            padding-bottom: 5px; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .canvas-wrapper { 
            flex-grow: 1; 
            position: relative; 
            width: 100%; 
        }
        /* Loading State Styling */
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>

<div class="viz-container">
    <div id="viz-header">Initialising Analysis...</div>
    <div class="canvas-wrapper">
        <div id="loading" class="loader">Fetching Aggregates...</div>
        <canvas id="vizChart"></canvas>
    </div>
</div>



<script>
    /**
     * ARCHITECTURAL CONTEXT: Sovereign Headless Display Logic
     * MISSION: One-way data retrieval for public visualization.
     */
    async function initVisualization() {
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('id');
        const headerEl = document.getElementById('viz-header');
        const loaderEl = document.getElementById('loading');

        if (!recordId) {
            headerEl.innerText = "Error: Record ID Missing";
            loaderEl.innerText = "Target a valid research ID via ?id=X";
            return;
        }

        try {
            /**
             * API HANDSHAKE
             * Fetches only the statistical bins. This ensures PII and raw 
             * content stay protected behind the server-side logic.
             */
            const response = await fetch(`/api/display/${recordId}`);
            if (!response.ok) throw new Error('Dataset not found');

            const data = await response.json();

            // Hide loader and update title
            loaderEl.style.display = 'none';
            headerEl.innerText = data.project_title;

            // Map database columns to Chart.js array
            const bins = [
                data.bin_n1_0, data.bin_n0_8, data.bin_n0_6, data.bin_n0_4, data.bin_n0_2,
                data.bin_0_0,
                data.bin_p0_2, data.bin_p0_4, data.bin_p0_6, data.bin_p0_8, data.bin_p1_0
            ];

            renderChart(bins);
        } catch (err) {
            headerEl.innerText = "Visualisation Failed";
            loaderEl.innerText = err.message;
        }
    }

    /**
     * Renders the VADER Polarity Distribution
     * @param {Array} bins - The 11-step statistical distribution.
     */
    function renderChart(bins) {
        const ctx = document.getElementById('vizChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["-1.0", "-0.8", "-0.6", "-0.4", "-0.2", "0.0", "0.2", "0.4", "0.6", "0.8", "1.0"],
                datasets: [{
                    data: bins,
                    backgroundColor: '#05386B', // Institutional Navy
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#05386B',
                        titleFont: { size: 10 },
                        callbacks: {
                            label: (context) => ` Volume: ${context.parsed.y}`
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#f1f5f9' },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#64748b', font: { size: 10 } }
                    }
                }
            }
        });
    }

    // Trigger initialization on load
    window.onload = initVisualization;
</script>

</body>
</html>