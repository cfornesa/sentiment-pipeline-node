<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingestion Agent | Sentiment Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* DESIGN PHILOSOPHY: Institutional Cleanliness & High Contrast */
        body { background: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; padding: 15px; color: #0f172a; }
        .sw-container { max-width: 500px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }

        /* HEADER STYLING */
        .sw-header { border-bottom: 2px solid #05386B; margin-bottom: 20px; padding-bottom: 10px; }
        .sw-title { margin: 0; color: #05386B; font-size: 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.02em; }
        .sw-tagline { font-size: 13px; color: #64748b; margin-top: 5px; line-height: 1.4; }

        /* FORM COMPONENT STYLING */
        .sw-label { font-size: 10px; font-weight: 800; color: #475569; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .sw-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 14px; }
        .btn { background: #05386B; color: white; padding: 14px; border: none; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; text-decoration: none; display: block; text-align: center; font-size: 14px; transition: background 0.2s; }
        .btn:hover { background: #042b52; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* PRIVACY GOVERNANCE BLOCK */
        .privacy-block { background: #f1f5f9; padding: 12px; border-radius: 6px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 10px; }
        .privacy-text { font-size: 11px; color: #475569; line-height: 1.5; }

        /* RESULT VIEWPORT (Hidden by default) */
        .result-area { display: none; margin-top: 20px; }
        .copy-group { display: flex; gap: 5px; margin-bottom: 20px; }
        .copy-input { flex-grow: 1; font-family: monospace; font-size: 11px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; background: #f8fafc; }

        /* GRID LOGIC */
        .sw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 480px) { .sw-grid { grid-template-columns: 1fr; gap: 0; } }
    </style>
</head>
<body>

<div class="sw-container">
    <header class="sw-header">
        <h1 class="sw-title">Sentiment Pipeline</h1>
        <p class="sw-tagline">Securely preprocess CSV datasets and generate distribution visualizations.</p>
    </header>

    <form id="ingestForm">
        <label class="sw-label">Research Dataset (CSV)</label>
        <input type="file" id="csv_file" name="csv_file" required style="margin-bottom:15px; font-size: 12px;">

        <label class="sw-label">Project Identifier</label>
        <input type="text" id="chart_title" name="chart_title" class="sw-input" placeholder="e.g. Narrative Analysis 2025" required>

        <div class="sw-grid">
            <div>
                <label class="sw-label">Content Column</label>
                <input type="text" id="post_column" name="post_column" class="sw-input" value="post">
            </div>
            <div>
                <label class="sw-label">Temporal Column</label>
                <input type="text" id="date_column" name="date_column" class="sw-input" value="date">
            </div>
        </div>

        <div class="privacy-block">
            <input type="checkbox" id="privacyConsent" required>
            <label for="privacyConsent" class="privacy-text">
                I verify that binned aggregates will be stored. No raw PII or research text is retained. Read the <a href="#" style="color:#05386B; font-weight:600;">Privacy Policy</a>.
            </label>
        </div>

        <button type="submit" id="submitBtn" class="btn">Initialize Sovereign Analysis</button>
    </form>

    <section id="resultArea" class="result-area">
        <h3 style="font-size: 14px; color: #379683; margin-top:0;">âœ” Analysis Complete</h3>

        <label class="sw-label">Institutional Embed Code</label>
        <div class="copy-group">
            <input type="text" id="embedCode" class="copy-input" readonly>
            <button onclick="copyEmbed()" style="background:#379683; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:10px; font-weight:bold;">COPY</button>
        </div>

        <div style="height:250px;"><canvas id="resultChart"></canvas></div>

        <button onclick="location.reload()" class="btn" style="background:#64748b; margin-top:20px;">New Analysis</button>
    </section>
</div>



<script>
    /**
     * ARCHITECTURAL CONTEXT: Sovereign UI Logic
     * Handles the asynchronous orchestration of the sentiment pipeline.
     */
    const ingestForm = document.getElementById('ingestForm');
    const submitBtn = document.getElementById('submitBtn');
    const resultArea = document.getElementById('resultArea');
    let myChart = null;

    ingestForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 1. ASYNCHRONOUS DATA PREPARATION
        const formData = new FormData();
        formData.append('csv_file', document.getElementById('csv_file').files[0]);
        formData.append('chart_title', document.getElementById('chart_title').value);
        formData.append('post_column', document.getElementById('post_column').value);

        // 2. UI LOCKING: Prevent concurrent submissions
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing Pipeline...";

        try {
            /**
             * 3. API HANDSHAKE
             * Using Fetch to communicate with the Express /api/ingest route.
             */
            const response = await fetch('/api/ingest', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // 4. TRANSITION: Toggle from Ingestion to Visualization
                ingestForm.style.display = 'none';
                resultArea.style.display = 'block';

                /**
                 * 5. EMBED GENERATION
                 * Leverages the window context to create an portable iframe code.
                 */
                const embedUrl = `${window.location.origin}/display.html?id=${data.id}`;
                document.getElementById('embedCode').value = `<iframe src="${embedUrl}" width="100%" height="400" frameborder="0"></iframe>`;

                // 6. RENDER DATA DISTRIBUTION
                renderChart(data.bins);
            } else {
                throw new Error(data.error || "Ingestion Failed");
            }
        } catch (err) {
            console.error(err);
            alert("Sovereign Pipeline Error: " + err.message);
            submitBtn.disabled = false;
            submitBtn.innerText = "Initialize Sovereign Analysis";
        }
    });

    /**
     * Renders the 11-bin Polarity Distribution via Chart.js
     * @param {Array} bins - The integer counts for each sentiment polarity bucket.
     */
    function renderChart(bins) {
        const ctx = document.getElementById('resultChart').getContext('2d');
        if (myChart) myChart.destroy(); // Clear existing instance if it exists

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["-1.0", "-0.8", "-0.6", "-0.4", "-0.2", "0", "0.2", "0.4", "0.6", "0.8", "1.0"],
                datasets: [{ 
                    data: bins, 
                    backgroundColor: '#05386B',
                    borderRadius: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    /**
     * Clipboard Utility
     */
    function copyEmbed() {
        const copyText = document.getElementById("embedCode");
        copyText.select();
        document.execCommand("copy");
        alert("Institutional embed code copied to clipboard!");
    }
</script>

</body>
</html>